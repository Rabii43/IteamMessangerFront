import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { categories, EmojiData, EmojiService, } from '@ctrl/ngx-emoji-mart/ngx-emoji';
import { intersect } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@ctrl/ngx-emoji-mart/ngx-emoji";
var EmojiSearch = /** @class */ (function () {
    function EmojiSearch(emojiService) {
        var e_1, _a;
        var _this = this;
        this.emojiService = emojiService;
        this.originalPool = {};
        this.index = {};
        this.emojisList = {};
        this.emoticonsList = {};
        this.emojiSearch = {};
        var _loop_1 = function (emojiData) {
            var shortNames = emojiData.shortNames, emoticons = emojiData.emoticons;
            var id = shortNames[0];
            emoticons.forEach(function (emoticon) {
                if (_this.emoticonsList[emoticon]) {
                    return;
                }
                _this.emoticonsList[emoticon] = id;
            });
            this_1.emojisList[id] = this_1.emojiService.getSanitizedData(id);
            this_1.originalPool[id] = emojiData;
        };
        var this_1 = this;
        try {
            for (var _b = tslib_1.__values(this.emojiService.emojis), _c = _b.next(); !_c.done; _c = _b.next()) {
                var emojiData = _c.value;
                _loop_1(emojiData);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    }
    EmojiSearch.prototype.addCustomToPool = function (custom, pool) {
        var _this = this;
        custom.forEach(function (emoji) {
            var emojiId = emoji.id || emoji.shortNames[0];
            if (emojiId && !pool[emojiId]) {
                pool[emojiId] = _this.emojiService.getData(emoji);
                _this.emojisList[emojiId] = _this.emojiService.getSanitizedData(emoji);
            }
        });
    };
    EmojiSearch.prototype.search = function (value, emojisToShowFilter, maxResults, include, exclude, custom) {
        var _this = this;
        if (maxResults === void 0) { maxResults = 75; }
        if (include === void 0) { include = []; }
        if (exclude === void 0) { exclude = []; }
        if (custom === void 0) { custom = []; }
        this.addCustomToPool(custom, this.originalPool);
        var results;
        var pool = this.originalPool;
        if (value.length) {
            if (value === '-' || value === '-1') {
                return [this.emojisList['-1']];
            }
            if (value === '+' || value === '+1') {
                return [this.emojisList['+1']];
            }
            var values = value.toLowerCase().split(/[\s|,|\-|_]+/);
            var allResults = [];
            if (values.length > 2) {
                values = [values[0], values[1]];
            }
            if (include.length || exclude.length) {
                pool = {};
                categories.forEach(function (category) {
                    var isIncluded = include && include.length
                        ? include.indexOf(category.id) > -1
                        : true;
                    var isExcluded = exclude && exclude.length
                        ? exclude.indexOf(category.id) > -1
                        : false;
                    if (!isIncluded || isExcluded) {
                        return;
                    }
                    category.emojis.forEach(function (emojiId) {
                        // Need to make sure that pool gets keyed
                        // with the correct id, which is why we call emojiService.getData below
                        var emoji = _this.emojiService.getData(emojiId);
                        pool[emoji.id] = emoji;
                    });
                });
                if (custom.length) {
                    var customIsIncluded = include && include.length ? include.indexOf('custom') > -1 : true;
                    var customIsExcluded = exclude && exclude.length ? exclude.indexOf('custom') > -1 : false;
                    if (customIsIncluded && !customIsExcluded) {
                        this.addCustomToPool(custom, pool);
                    }
                }
            }
            allResults = values
                .map(function (v) {
                var aPool = pool;
                var aIndex = _this.index;
                var length = 0;
                var _loop_2 = function (charIndex) {
                    var e_2, _a;
                    var char = v[charIndex];
                    length++;
                    if (!aIndex[char]) {
                        aIndex[char] = {};
                    }
                    aIndex = aIndex[char];
                    if (!aIndex.results) {
                        var scores_1 = {};
                        aIndex.results = [];
                        aIndex.pool = {};
                        try {
                            for (var _b = (e_2 = void 0, tslib_1.__values(Object.keys(aPool))), _c = _b.next(); !_c.done; _c = _b.next()) {
                                var id = _c.value;
                                var emoji = aPool[id];
                                if (!_this.emojiSearch[id]) {
                                    _this.emojiSearch[id] = _this.buildSearch(emoji.short_names, emoji.name, emoji.keywords, emoji.emoticons);
                                }
                                var query = _this.emojiSearch[id];
                                var sub = v.substr(0, length);
                                var subIndex = query.indexOf(sub);
                                if (subIndex !== -1) {
                                    var score = subIndex + 1;
                                    if (sub === id) {
                                        score = 0;
                                    }
                                    aIndex.results.push(_this.emojisList[id]);
                                    aIndex.pool[id] = emoji;
                                    scores_1[id] = score;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                        aIndex.results.sort(function (a, b) {
                            var aScore = scores_1[a.id];
                            var bScore = scores_1[b.id];
                            return aScore - bScore;
                        });
                    }
                    aPool = aIndex.pool;
                };
                // tslint:disable-next-line: prefer-for-of
                for (var charIndex = 0; charIndex < v.length; charIndex++) {
                    _loop_2(charIndex);
                }
                return aIndex.results;
            })
                .filter(function (a) { return a; });
            if (allResults.length > 1) {
                results = intersect.apply(null, allResults);
            }
            else if (allResults.length) {
                results = allResults[0];
            }
            else {
                results = [];
            }
        }
        if (results) {
            if (emojisToShowFilter) {
                results = results.filter(function (result) {
                    if (result && result.id) {
                        return emojisToShowFilter(_this.emojiService.names[result.id]);
                    }
                    return false;
                });
            }
            if (results && results.length > maxResults) {
                results = results.slice(0, maxResults);
            }
        }
        return results || null;
    };
    EmojiSearch.prototype.buildSearch = function (shortNames, name, keywords, emoticons) {
        var search = [];
        var addToSearch = function (strings, split) {
            if (!strings) {
                return;
            }
            (Array.isArray(strings) ? strings : [strings]).forEach(function (str) {
                (split ? str.split(/[-|_|\s]+/) : [str]).forEach(function (s) {
                    s = s.toLowerCase();
                    if (!search.includes(s)) {
                        search.push(s);
                    }
                });
            });
        };
        addToSearch(shortNames, true);
        addToSearch(name, true);
        addToSearch(keywords, false);
        addToSearch(emoticons, false);
        return search.join(',');
    };
    EmojiSearch.ctorParameters = function () { return [
        { type: EmojiService }
    ]; };
    EmojiSearch.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function EmojiSearch_Factory() { return new EmojiSearch(i0.ɵɵinject(i1.EmojiService)); }, token: EmojiSearch, providedIn: "root" });
    EmojiSearch = tslib_1.__decorate([
        Injectable({ providedIn: 'root' }),
        tslib_1.__metadata("design:paramtypes", [EmojiService])
    ], EmojiSearch);
    return EmojiSearch;
}());
export { EmojiSearch };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamktc2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY3RybC9uZ3gtZW1vamktbWFydC8iLCJzb3VyY2VzIjpbImVtb2ppLXNlYXJjaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFDTCxVQUFVLEVBQ1YsU0FBUyxFQUNULFlBQVksR0FDYixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7OztBQUdwQztJQVdFLHFCQUFvQixZQUEwQjs7UUFBOUMsaUJBZ0JDO1FBaEJtQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVY5QyxpQkFBWSxHQUFRLEVBQUUsQ0FBQztRQUN2QixVQUFLLEdBSUQsRUFBRSxDQUFDO1FBQ1AsZUFBVSxHQUFRLEVBQUUsQ0FBQztRQUNyQixrQkFBYSxHQUE4QixFQUFFLENBQUM7UUFDOUMsZ0JBQVcsR0FBOEIsRUFBRSxDQUFDO2dDQUcvQixTQUFTO1lBQ1YsSUFBQSxpQ0FBVSxFQUFFLCtCQUFTLENBQWU7WUFDNUMsSUFBTSxFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXpCLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQSxRQUFRO2dCQUN4QixJQUFJLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQ2hDLE9BQU87aUJBQ1I7Z0JBRUQsS0FBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDcEMsQ0FBQyxDQUFDLENBQUM7WUFFSCxPQUFLLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFLLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM3RCxPQUFLLFlBQVksQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUM7Ozs7WUFicEMsS0FBd0IsSUFB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VyxFQUFFLENBQUM7b0JBRXBCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNoQjtnQkFDSCxDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBRUYsV0FBVyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5QixXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hCLFdBQVcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0IsV0FBVyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU5QixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUIsQ0FBQzs7Z0JBck5pQyxZQUFZOzs7SUFYbkMsV0FBVztRQUR2QixVQUFVLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUM7aURBWUMsWUFBWTtPQVhuQyxXQUFXLENBaU92QjtzQkEzT0Q7Q0EyT0MsQUFqT0QsSUFpT0M7U0FqT1ksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgY2F0ZWdvcmllcyxcbiAgRW1vamlEYXRhLFxuICBFbW9qaVNlcnZpY2UsXG59IGZyb20gJ0BjdHJsL25neC1lbW9qaS1tYXJ0L25neC1lbW9qaSc7XG5pbXBvcnQgeyBpbnRlcnNlY3QgfSBmcm9tICcuL3V0aWxzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBFbW9qaVNlYXJjaCB7XG4gIG9yaWdpbmFsUG9vbDogYW55ID0ge307XG4gIGluZGV4OiB7XG4gICAgcmVzdWx0cz86IEVtb2ppRGF0YVtdO1xuICAgIHBvb2w/OiB7IFtrZXk6IHN0cmluZ106IEVtb2ppRGF0YSB9O1xuICAgIFtrZXk6IHN0cmluZ106IGFueTtcbiAgfSA9IHt9O1xuICBlbW9qaXNMaXN0OiBhbnkgPSB7fTtcbiAgZW1vdGljb25zTGlzdDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICBlbW9qaVNlYXJjaDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZW1vamlTZXJ2aWNlOiBFbW9qaVNlcnZpY2UpIHtcbiAgICBmb3IgKGNvbnN0IGVtb2ppRGF0YSBvZiB0aGlzLmVtb2ppU2VydmljZS5lbW9qaXMpIHtcbiAgICAgIGNvbnN0IHsgc2hvcnROYW1lcywgZW1vdGljb25zIH0gPSBlbW9qaURhdGE7XG4gICAgICBjb25zdCBpZCA9IHNob3J0TmFtZXNbMF07XG5cbiAgICAgIGVtb3RpY29ucy5mb3JFYWNoKGVtb3RpY29uID0+IHtcbiAgICAgICAgaWYgKHRoaXMuZW1vdGljb25zTGlzdFtlbW90aWNvbl0pIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmVtb3RpY29uc0xpc3RbZW1vdGljb25dID0gaWQ7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5lbW9qaXNMaXN0W2lkXSA9IHRoaXMuZW1vamlTZXJ2aWNlLmdldFNhbml0aXplZERhdGEoaWQpO1xuICAgICAgdGhpcy5vcmlnaW5hbFBvb2xbaWRdID0gZW1vamlEYXRhO1xuICAgIH1cbiAgfVxuXG4gIGFkZEN1c3RvbVRvUG9vbChjdXN0b206IGFueSwgcG9vbDogYW55KSB7XG4gICAgY3VzdG9tLmZvckVhY2goKGVtb2ppOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGVtb2ppSWQgPSBlbW9qaS5pZCB8fCBlbW9qaS5zaG9ydE5hbWVzWzBdO1xuXG4gICAgICBpZiAoZW1vamlJZCAmJiAhcG9vbFtlbW9qaUlkXSkge1xuICAgICAgICBwb29sW2Vtb2ppSWRdID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0RGF0YShlbW9qaSk7XG4gICAgICAgIHRoaXMuZW1vamlzTGlzdFtlbW9qaUlkXSA9IHRoaXMuZW1vamlTZXJ2aWNlLmdldFNhbml0aXplZERhdGEoZW1vamkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2VhcmNoKFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgZW1vamlzVG9TaG93RmlsdGVyPzogKHg6IGFueSkgPT4gYm9vbGVhbixcbiAgICBtYXhSZXN1bHRzID0gNzUsXG4gICAgaW5jbHVkZTogYW55W10gPSBbXSxcbiAgICBleGNsdWRlOiBhbnlbXSA9IFtdLFxuICAgIGN1c3RvbTogYW55W10gPSBbXSxcbiAgKTogRW1vamlEYXRhW10gfCBudWxsIHtcbiAgICB0aGlzLmFkZEN1c3RvbVRvUG9vbChjdXN0b20sIHRoaXMub3JpZ2luYWxQb29sKTtcblxuICAgIGxldCByZXN1bHRzOiBFbW9qaURhdGFbXSB8IHVuZGVmaW5lZDtcbiAgICBsZXQgcG9vbCA9IHRoaXMub3JpZ2luYWxQb29sO1xuXG4gICAgaWYgKHZhbHVlLmxlbmd0aCkge1xuICAgICAgaWYgKHZhbHVlID09PSAnLScgfHwgdmFsdWUgPT09ICctMScpIHtcbiAgICAgICAgcmV0dXJuIFt0aGlzLmVtb2ppc0xpc3RbJy0xJ11dO1xuICAgICAgfVxuICAgICAgaWYgKHZhbHVlID09PSAnKycgfHwgdmFsdWUgPT09ICcrMScpIHtcbiAgICAgICAgcmV0dXJuIFt0aGlzLmVtb2ppc0xpc3RbJysxJ11dO1xuICAgICAgfVxuXG4gICAgICBsZXQgdmFsdWVzID0gdmFsdWUudG9Mb3dlckNhc2UoKS5zcGxpdCgvW1xcc3wsfFxcLXxfXSsvKTtcbiAgICAgIGxldCBhbGxSZXN1bHRzID0gW107XG5cbiAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMikge1xuICAgICAgICB2YWx1ZXMgPSBbdmFsdWVzWzBdLCB2YWx1ZXNbMV1dO1xuICAgICAgfVxuXG4gICAgICBpZiAoaW5jbHVkZS5sZW5ndGggfHwgZXhjbHVkZS5sZW5ndGgpIHtcbiAgICAgICAgcG9vbCA9IHt9O1xuXG4gICAgICAgIGNhdGVnb3JpZXMuZm9yRWFjaChjYXRlZ29yeSA9PiB7XG4gICAgICAgICAgY29uc3QgaXNJbmNsdWRlZCA9XG4gICAgICAgICAgICBpbmNsdWRlICYmIGluY2x1ZGUubGVuZ3RoXG4gICAgICAgICAgICAgID8gaW5jbHVkZS5pbmRleE9mKGNhdGVnb3J5LmlkKSA+IC0xXG4gICAgICAgICAgICAgIDogdHJ1ZTtcbiAgICAgICAgICBjb25zdCBpc0V4Y2x1ZGVkID1cbiAgICAgICAgICAgIGV4Y2x1ZGUgJiYgZXhjbHVkZS5sZW5ndGhcbiAgICAgICAgICAgICAgPyBleGNsdWRlLmluZGV4T2YoY2F0ZWdvcnkuaWQpID4gLTFcbiAgICAgICAgICAgICAgOiBmYWxzZTtcbiAgICAgICAgICBpZiAoIWlzSW5jbHVkZWQgfHwgaXNFeGNsdWRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNhdGVnb3J5LmVtb2ppcy5mb3JFYWNoKFxuICAgICAgICAgICAgZW1vamlJZCA9PiB7XG4gICAgICAgICAgICAgIC8vIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgcG9vbCBnZXRzIGtleWVkXG4gICAgICAgICAgICAgIC8vIHdpdGggdGhlIGNvcnJlY3QgaWQsIHdoaWNoIGlzIHdoeSB3ZSBjYWxsIGVtb2ppU2VydmljZS5nZXREYXRhIGJlbG93XG4gICAgICAgICAgICAgIGNvbnN0IGVtb2ppID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0RGF0YShlbW9qaUlkKTtcbiAgICAgICAgICAgICAgcG9vbFtlbW9qaS5pZF0gPSBlbW9qaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY3VzdG9tLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IGN1c3RvbUlzSW5jbHVkZWQgPVxuICAgICAgICAgICAgaW5jbHVkZSAmJiBpbmNsdWRlLmxlbmd0aCA/IGluY2x1ZGUuaW5kZXhPZignY3VzdG9tJykgPiAtMSA6IHRydWU7XG4gICAgICAgICAgY29uc3QgY3VzdG9tSXNFeGNsdWRlZCA9XG4gICAgICAgICAgICBleGNsdWRlICYmIGV4Y2x1ZGUubGVuZ3RoID8gZXhjbHVkZS5pbmRleE9mKCdjdXN0b20nKSA+IC0xIDogZmFsc2U7XG4gICAgICAgICAgaWYgKGN1c3RvbUlzSW5jbHVkZWQgJiYgIWN1c3RvbUlzRXhjbHVkZWQpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbSwgcG9vbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGFsbFJlc3VsdHMgPSB2YWx1ZXNcbiAgICAgICAgLm1hcCh2ID0+IHtcbiAgICAgICAgICBsZXQgYVBvb2wgPSBwb29sO1xuICAgICAgICAgIGxldCBhSW5kZXggPSB0aGlzLmluZGV4O1xuICAgICAgICAgIGxldCBsZW5ndGggPSAwO1xuXG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZm9yLW9mXG4gICAgICAgICAgZm9yIChsZXQgY2hhckluZGV4ID0gMDsgY2hhckluZGV4IDwgdi5sZW5ndGg7IGNoYXJJbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFyID0gdltjaGFySW5kZXhdO1xuICAgICAgICAgICAgbGVuZ3RoKys7XG4gICAgICAgICAgICBpZiAoIWFJbmRleFtjaGFyXSkge1xuICAgICAgICAgICAgICBhSW5kZXhbY2hhcl0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFJbmRleCA9IGFJbmRleFtjaGFyXTtcblxuICAgICAgICAgICAgaWYgKCFhSW5kZXgucmVzdWx0cykge1xuICAgICAgICAgICAgICBjb25zdCBzY29yZXM6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0gPSB7fTtcblxuICAgICAgICAgICAgICBhSW5kZXgucmVzdWx0cyA9IFtdO1xuICAgICAgICAgICAgICBhSW5kZXgucG9vbCA9IHt9O1xuXG4gICAgICAgICAgICAgIGZvciAoY29uc3QgaWQgb2YgT2JqZWN0LmtleXMoYVBvb2wpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW1vamkgPSBhUG9vbFtpZF07XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmVtb2ppU2VhcmNoW2lkXSkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5lbW9qaVNlYXJjaFtpZF0gPSB0aGlzLmJ1aWxkU2VhcmNoKFxuICAgICAgICAgICAgICAgICAgICBlbW9qaS5zaG9ydF9uYW1lcyxcbiAgICAgICAgICAgICAgICAgICAgZW1vamkubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZW1vamkua2V5d29yZHMsXG4gICAgICAgICAgICAgICAgICAgIGVtb2ppLmVtb3RpY29ucyxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5lbW9qaVNlYXJjaFtpZF07XG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdi5zdWJzdHIoMCwgbGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJJbmRleCA9IHF1ZXJ5LmluZGV4T2Yoc3ViKTtcblxuICAgICAgICAgICAgICAgIGlmIChzdWJJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IHN1YkluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICAgIGlmIChzdWIgPT09IGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlID0gMDtcbiAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgYUluZGV4LnJlc3VsdHMucHVzaCh0aGlzLmVtb2ppc0xpc3RbaWRdKTtcbiAgICAgICAgICAgICAgICAgIGFJbmRleC5wb29sW2lkXSA9IGVtb2ppO1xuXG4gICAgICAgICAgICAgICAgICBzY29yZXNbaWRdID0gc2NvcmU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgYUluZGV4LnJlc3VsdHMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFTY29yZSA9IHNjb3Jlc1thLmlkXTtcbiAgICAgICAgICAgICAgICBjb25zdCBiU2NvcmUgPSBzY29yZXNbYi5pZF07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYVNjb3JlIC0gYlNjb3JlO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYVBvb2wgPSBhSW5kZXgucG9vbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gYUluZGV4LnJlc3VsdHM7XG4gICAgICAgIH0pXG4gICAgICAgIC5maWx0ZXIoYSA9PiBhKTtcblxuICAgICAgaWYgKGFsbFJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgICByZXN1bHRzID0gaW50ZXJzZWN0LmFwcGx5KG51bGwsIGFsbFJlc3VsdHMgYXMgYW55KTtcbiAgICAgIH0gZWxzZSBpZiAoYWxsUmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgcmVzdWx0cyA9IGFsbFJlc3VsdHNbMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRzID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdHMpIHtcbiAgICAgIGlmIChlbW9qaXNUb1Nob3dGaWx0ZXIpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKChyZXN1bHQ6IEVtb2ppRGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmlkKSB7XG4gICAgICAgICAgICByZXR1cm4gZW1vamlzVG9TaG93RmlsdGVyKHRoaXMuZW1vamlTZXJ2aWNlLm5hbWVzW3Jlc3VsdC5pZF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAocmVzdWx0cyAmJiByZXN1bHRzLmxlbmd0aCA+IG1heFJlc3VsdHMpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuc2xpY2UoMCwgbWF4UmVzdWx0cyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzIHx8IG51bGw7XG4gIH1cblxuICBidWlsZFNlYXJjaChcbiAgICBzaG9ydE5hbWVzOiBzdHJpbmdbXSxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAga2V5d29yZHM6IHN0cmluZ1tdLFxuICAgIGVtb3RpY29uczogc3RyaW5nW10sXG4gICkge1xuICAgIGNvbnN0IHNlYXJjaDogc3RyaW5nW10gPSBbXTtcblxuICAgIGNvbnN0IGFkZFRvU2VhcmNoID0gKHN0cmluZ3M6IHN0cmluZyB8IHN0cmluZ1tdLCBzcGxpdDogYm9vbGVhbikgPT4ge1xuICAgICAgaWYgKCFzdHJpbmdzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgKEFycmF5LmlzQXJyYXkoc3RyaW5ncykgPyBzdHJpbmdzIDogW3N0cmluZ3NdKS5mb3JFYWNoKHN0ciA9PiB7XG4gICAgICAgIChzcGxpdCA/IHN0ci5zcGxpdCgvWy18X3xcXHNdKy8pIDogW3N0cl0pLmZvckVhY2gocyA9PiB7XG4gICAgICAgICAgcyA9IHMudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgIGlmICghc2VhcmNoLmluY2x1ZGVzKHMpKSB7XG4gICAgICAgICAgICBzZWFyY2gucHVzaChzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGFkZFRvU2VhcmNoKHNob3J0TmFtZXMsIHRydWUpO1xuICAgIGFkZFRvU2VhcmNoKG5hbWUsIHRydWUpO1xuICAgIGFkZFRvU2VhcmNoKGtleXdvcmRzLCBmYWxzZSk7XG4gICAgYWRkVG9TZWFyY2goZW1vdGljb25zLCBmYWxzZSk7XG5cbiAgICByZXR1cm4gc2VhcmNoLmpvaW4oJywnKTtcbiAgfVxufVxuIl19